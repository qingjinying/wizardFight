{
  "code": "import { E, EventName } from \"../manager/E\";\r\nimport { ui } from \"../ui/layaMaxUI\";\r\nexport class WarMapView extends ui.warMapUI {\r\n    constructor(ctrl) {\r\n        super();\r\n        this.minX = -1096;\r\n        this.minY = -155;\r\n        this.mLastMouseX = 0;\r\n        this.mLastMouseY = 0;\r\n        this.mX = 0;\r\n        this.mY = 0;\r\n        this.glowFilter = new Laya.GlowFilter(\"#ffff00\", 10, 0, 0);\r\n        this.glowFilter_move = new Laya.GlowFilter(\"#ffffff\", 10, 0, 0);\r\n        this.moveFilterInsList = [];\r\n        this.moveReadyFlo = false;\r\n        this._ctrl = ctrl;\r\n        this.operationBox.y = Laya.stage.height - 120;\r\n        this.otherTer.y = Laya.stage.height - 120;\r\n        this.conscriptionPanel.y = Laya.stage.height - 100;\r\n        this.movePanel.y = Laya.stage.height - 100;\r\n        this.nothing_dialog.y = ~~(Laya.stage.height / 2 - 100);\r\n        this.uniteAlert.y = ~~(Laya.stage.height / 2 - 50);\r\n        this.fightResult.y = ~~(Laya.stage.height / 2 - 200);\r\n        this.moveAlert.y = Laya.stage.height - 120;\r\n        this.minY = Laya.stage.height - 1498;\r\n        this.minX = Laya.stage.width - 1733;\r\n        let w = Laya.Browser.clientWidth;\r\n        let h = Laya.Browser.clientHeight;\r\n        if (h / w >= 2) {\r\n            this.infoBoard.top = 50;\r\n        }\r\n        this.on(Laya.Event.MOUSE_DOWN, this, this.mouseDown);\r\n        this.on(Laya.Event.MOUSE_UP, this, this.mouseUp);\r\n        this.terAddMonitor();\r\n        this.btn_move.on(Laya.Event.CLICK, this, this.onMove);\r\n        this.btn_cancel_move.on(Laya.Event.CLICK, this, this.cancelMove);\r\n        this.move_btn_confirm.on(Laya.Event.CLICK, this, this.confirmMove);\r\n        this.move_btn_cancel.on(Laya.Event.CLICK, this, this.moveCancel);\r\n        this.btn_recruit.on(Laya.Event.CLICK, this, this.onRecruit);\r\n        this.btn_end.on(Laya.Event.CLICK, this, this.onEnd);\r\n        this.con_btn_confirm.on(Laya.Event.CLICK, this, this.confirmRecruit);\r\n        this.con_btn_cancel.on(Laya.Event.CLICK, this, this.cancelRecruit);\r\n        this.btn_fight_close.on(Laya.Event.CLICK, this, this.closeFightResult);\r\n        this.nextStep.on(Laya.Event.CLICK, this, this.closeSettlement);\r\n        this.no_btn_yes.on(Laya.Event.CLICK, this, this.doNothing_yes);\r\n        this.no_btn_no.on(Laya.Event.CLICK, this, this.doNothing_no);\r\n        this.btn_back.on(Laya.Event.CLICK, this, this.leaveGameScene);\r\n        this.con_btn_ctrl.on(Laya.Event.MOUSE_DOWN, this, this.conMouseDown);\r\n        this.con_btn_ctrl.on(Laya.Event.MOUSE_UP, this, this.conMouseUp);\r\n        this.move_btn_ctrl.on(Laya.Event.MOUSE_DOWN, this, this.moveMouseDown);\r\n        this.move_btn_ctrl.on(Laya.Event.MOUSE_UP, this, this.moveMouseUp);\r\n        this.init();\r\n    }\r\n    init() {\r\n        this.operationBox.visible = false;\r\n        this.conscriptionPanel.visible = false;\r\n        this.nothing_dialog.visible = false;\r\n        this.settlementBoard.visible = false;\r\n        this.otherTer.visible = false;\r\n        this.moveAlert.visible = false;\r\n        this.movePanel.visible = false;\r\n        this.fightResult.visible = false;\r\n        this.uniteAlert.visible = false;\r\n        this.refreshTerColor();\r\n        this.refreshSoldier();\r\n        this.refreshInfoBoard();\r\n        this.container.x = -1140;\r\n        this.container.y = -44;\r\n        Laya.timer.once(100, this, this.areaClick, [3]);\r\n    }\r\n    terAddMonitor() {\r\n        for (let i = 1; i <= 30; i++) {\r\n            this[`area${i}`].on(Laya.Event.CLICK, this, this.areaClick, [i]);\r\n        }\r\n    }\r\n    areaClick(areaID) {\r\n        if (this.moveReadyFlo) {\r\n            let flo = this._ctrl.isMoveAvaliable(areaID);\r\n            if (!flo)\r\n                return;\r\n            this.moveSoldier(areaID);\r\n        }\r\n        else {\r\n            this.applayFilter(areaID);\r\n            this._ctrl.areaClick(areaID);\r\n        }\r\n    }\r\n    applayFilter(areaID) {\r\n        let ins = this[`area${areaID}`];\r\n        if (this.curFilterIns == ins)\r\n            return;\r\n        if (this.curFilterIns) {\r\n            this.curFilterIns.filters = [];\r\n        }\r\n        ins.filters = [this.glowFilter];\r\n        this.curFilterIns = ins;\r\n    }\r\n    showOperationBox() {\r\n        this.operationBox.visible = true;\r\n        this.otherTer.visible = false;\r\n    }\r\n    showOtherTer(msg) {\r\n        this.otherTer.visible = true;\r\n        this.operationBox.visible = false;\r\n        this.otherText.text = msg;\r\n    }\r\n    refreshTerColor() {\r\n        let terMap = this._ctrl.terMap;\r\n        for (let i = 1; i <= 30; i++) {\r\n            let terData = terMap[i];\r\n            this.updateAreaColor(terData);\r\n        }\r\n    }\r\n    refreshSoldier() {\r\n        let terMap = this._ctrl.terMap;\r\n        for (let i = 1; i <= 30; i++) {\r\n            let terData = terMap[i];\r\n            this.updateSoldier(terData);\r\n        }\r\n    }\r\n    updateAreaColor(terData) {\r\n        let skinUrl = terData.skinUrl;\r\n        this[`area${terData.id}`].loadImage(skinUrl);\r\n    }\r\n    updateSoldier(terData) {\r\n        let flo = terData.showSoldier;\r\n        if (flo) {\r\n            this[`soldier${terData.id}`].text = terData.soldierNum + \"\";\r\n            this[`soldier${terData.id}`].visible = true;\r\n        }\r\n        else {\r\n            this[`soldier${terData.id}`].visible = false;\r\n        }\r\n    }\r\n    refreshInfoBoard() {\r\n        this.goldNum.text = this._ctrl.goldNum + \"\";\r\n        this.roundCount.text = `第 ${this._ctrl.roundCount} 回合`;\r\n    }\r\n    updateGold() {\r\n        this.goldNum.text = this._ctrl.goldNum + \"\";\r\n    }\r\n    mouseDown() {\r\n        this.mLastMouseX = Laya.stage.mouseX;\r\n        this.mLastMouseY = Laya.stage.mouseY;\r\n        this.on(Laya.Event.MOUSE_MOVE, this, this.mouseMove);\r\n    }\r\n    mouseMove() {\r\n        let moveX = this.mX + (Laya.stage.mouseX - this.mLastMouseX);\r\n        let moveY = this.mY + (Laya.stage.mouseY - this.mLastMouseY);\r\n        if ((moveX <= 0) && (moveX > this.minX)) {\r\n            this.container.x = moveX;\r\n        }\r\n        if ((moveY <= 0) && (moveY > this.minY)) {\r\n            this.container.y = moveY;\r\n        }\r\n    }\r\n    mouseUp() {\r\n        this.mX = this.container.x;\r\n        this.mY = this.container.y;\r\n        this.off(Laya.Event.MOUSE_MOVE, this, this.mouseMove);\r\n        this.con_btn_ctrl.off(Laya.Event.MOUSE_MOVE, this, this.conMouseMove);\r\n    }\r\n    onMove() {\r\n        this.renderMoveArea();\r\n    }\r\n    renderMoveArea() {\r\n        this.moveReadyFlo = true;\r\n        this.moveAlert.visible = true;\r\n        this.operationBox.visible = false;\r\n        let currentId = this._ctrl.getCurrentId();\r\n        let neiborIdList = this._ctrl.getCurrentNeiborIdList();\r\n        for (let id of neiborIdList) {\r\n            this.applayFilter_move(id);\r\n            this.drawDottedLine(currentId, id);\r\n        }\r\n    }\r\n    applayFilter_move(areaID) {\r\n        let ins = this[`area${areaID}`];\r\n        ins.filters = [this.glowFilter_move];\r\n        this.moveFilterInsList.push(ins);\r\n    }\r\n    clearFilter_move() {\r\n        for (let ins of this.moveFilterInsList) {\r\n            ins.filters = [];\r\n        }\r\n        this.moveFilterInsList.length = 0;\r\n    }\r\n    drawDottedLine(startID, endID, isRed = false) {\r\n        let startCenter = this._ctrl.getCenter(startID);\r\n        let endCenter = this._ctrl.getCenter(endID);\r\n        let num = 30;\r\n        let startX = startCenter[0];\r\n        let startY = startCenter[1];\r\n        let endX = endCenter[0];\r\n        let endY = endCenter[1];\r\n        let disX = endX - startX;\r\n        let disY = endY - startY;\r\n        let lenX = disX / num;\r\n        let lenY = disY / num;\r\n        for (let i = 1; i <= num; i += 2) {\r\n            this.lineBox.graphics.drawLine(startX + (lenX * i), startY + (lenY * i), startX + (lenX * i) + lenX, startY + (lenY * i) + lenY, isRed ? \"#FF0000\" : \"#FFFFFF\", 3);\r\n        }\r\n    }\r\n    clearDottedLine() {\r\n        this.lineBox.graphics.clear(true);\r\n    }\r\n    cancelMove() {\r\n        this.moveReadyFlo = false;\r\n        this.operationBox.visible = true;\r\n        this.moveAlert.visible = false;\r\n        this.clearFilter_move();\r\n        this.clearDottedLine();\r\n    }\r\n    moveSoldier(areaID) {\r\n        this._moveTargetId = areaID;\r\n        this.clearFilter_move();\r\n        this.clearDottedLine();\r\n        this.moveAlert.visible = false;\r\n        this.applayFilter_move(areaID);\r\n        let currentId = this._ctrl.getCurrentId();\r\n        this.drawDottedLine(currentId, areaID, true);\r\n        this.movePanel.visible = true;\r\n        this.moveUpdateText();\r\n    }\r\n    moveMouseDown(e) {\r\n        e.stopPropagation();\r\n        this._moveX = this.move_btn_ctrl.mouseX;\r\n        this._moveValue = this.move_btn_ctrl.value;\r\n        this.move_btn_ctrl.on(Laya.Event.MOUSE_MOVE, this, this.moveMouseMove);\r\n    }\r\n    moveMouseMove() {\r\n        let distance = this.move_btn_ctrl.mouseX - this._moveX;\r\n        let rate = distance / 256;\r\n        let value = rate + this._moveValue;\r\n        if (value > 1) {\r\n            value = 1;\r\n        }\r\n        if (value < 0) {\r\n            value = 0;\r\n        }\r\n        this.move_btn_ctrl.value = value;\r\n        this.moveUpdateText();\r\n    }\r\n    moveMouseUp() {\r\n        this.off(Laya.Event.MOUSE_MOVE, this, this.mouseMove);\r\n        this.move_btn_ctrl.off(Laya.Event.MOUSE_MOVE, this, this.moveMouseMove);\r\n    }\r\n    moveUpdateText() {\r\n        let all = this._ctrl.getCurrentSoldier();\r\n        let current = Math.ceil(all * this.move_btn_ctrl.value);\r\n        let text = `移动 ${current} 兵力`;\r\n        this.move_text.text = text;\r\n    }\r\n    confirmMove() {\r\n        this.moveReadyFlo = false;\r\n        let num = Math.ceil(this._ctrl.getCurrentSoldier() * this.move_btn_ctrl.value);\r\n        this._ctrl.moveSoldier(this._moveTargetId, num);\r\n        this.movePanel.visible = false;\r\n        this.operationBox.visible = true;\r\n        this.clearFilter_move();\r\n        this.clearDottedLine();\r\n    }\r\n    moveCancel() {\r\n        this.moveReadyFlo = false;\r\n        this.movePanel.visible = false;\r\n        this.operationBox.visible = true;\r\n        this.clearFilter_move();\r\n        this.clearDottedLine();\r\n    }\r\n    alertFightResult(mySoldier, enemySoldier, myReduce, enemyReduce, isWin) {\r\n        this.myLossNum.text = `${mySoldier - myReduce}/${mySoldier}`;\r\n        this.myLossText.text = `损失 ${myReduce}`;\r\n        this.enemyLossNum.text = `${enemySoldier - enemyReduce}/${enemySoldier}`;\r\n        this.enemyLossText.text = `损失 ${enemyReduce}`;\r\n        this.myLossProgress.value = (mySoldier - myReduce) / mySoldier;\r\n        this.enemyLossProgress.value = (enemySoldier - enemyReduce) / enemySoldier;\r\n        if (isWin) {\r\n            this.myResult.loadImage(\"res/other/胜.png\");\r\n            this.enemyResult.loadImage(\"res/other/败.png\");\r\n        }\r\n        else {\r\n            this.myResult.loadImage(\"res/other/败.png\");\r\n            this.enemyResult.loadImage(\"res/other/胜.png\");\r\n        }\r\n        this.fightResult.visible = true;\r\n    }\r\n    closeFightResult() {\r\n        this.fightResult.visible = false;\r\n    }\r\n    onRecruit() {\r\n        this.conUpdateText();\r\n        this.conscriptionPanel.visible = true;\r\n        this.operationBox.visible = false;\r\n    }\r\n    conMouseDown(e) {\r\n        e.stopPropagation();\r\n        this._conX = this.con_btn_ctrl.mouseX;\r\n        this._conValue = this.con_btn_ctrl.value;\r\n        this.con_btn_ctrl.on(Laya.Event.MOUSE_MOVE, this, this.conMouseMove);\r\n    }\r\n    conMouseMove() {\r\n        let distance = this.con_btn_ctrl.mouseX - this._conX;\r\n        let rate = distance / 256;\r\n        let value = rate + this._conValue;\r\n        if (value > 1) {\r\n            value = 1;\r\n        }\r\n        if (value < 0) {\r\n            value = 0;\r\n        }\r\n        this.con_btn_ctrl.value = value;\r\n        this.conUpdateText();\r\n    }\r\n    conMouseUp() {\r\n        this.off(Laya.Event.MOUSE_MOVE, this, this.mouseMove);\r\n        this.con_btn_ctrl.off(Laya.Event.MOUSE_MOVE, this, this.conMouseMove);\r\n    }\r\n    conUpdateText() {\r\n        let all = this._ctrl.goldNum;\r\n        let current = Math.ceil(all * this.con_btn_ctrl.value);\r\n        let text = `招募 ${current} 单位, 费用 ${current} 金`;\r\n        this.con_text.text = text;\r\n    }\r\n    confirmRecruit() {\r\n        let num = Math.ceil(this._ctrl.goldNum * this.con_btn_ctrl.value);\r\n        this._ctrl.recruitSoldier(num);\r\n        this.conscriptionPanel.visible = false;\r\n        this.operationBox.visible = true;\r\n    }\r\n    cancelRecruit() {\r\n        this.conscriptionPanel.visible = false;\r\n        this.operationBox.visible = true;\r\n    }\r\n    onEnd() {\r\n        if (!this._ctrl.activieFlo) {\r\n            this.nothing_dialog.visible = true;\r\n        }\r\n        else {\r\n            this.operationBox.visible = false;\r\n            this._ctrl.roundEnd();\r\n        }\r\n    }\r\n    doNothing_yes() {\r\n        this.nothing_dialog.visible = false;\r\n        this.operationBox.visible = false;\r\n        this._ctrl.roundEnd();\r\n    }\r\n    doNothing_no() {\r\n        this.nothing_dialog.visible = false;\r\n    }\r\n    alertSettlement(original, product, consume) {\r\n        this.set_cur_gold.text = original + \"\";\r\n        this.set_cur_gold.x = 497 - this.set_cur_gold.text.length * 13;\r\n        this.set_get_gold.text = product + \"\";\r\n        this.set_get_gold.x = 497 - this.set_get_gold.text.length * 13;\r\n        this.set_consume_gold.text = consume + \"\";\r\n        this.set_consume_gold.x = 497 - this.set_consume_gold.text.length * 13;\r\n        let lastGold = product - consume;\r\n        if (lastGold > 0) {\r\n            this.set_last_gold.text = \"+\" + lastGold + \"\";\r\n            this.set_last_gold.color = \"#268d3b\";\r\n        }\r\n        else {\r\n            this.set_last_gold.text = lastGold + \"\";\r\n            this.set_last_gold.color = \"#fd2001\";\r\n        }\r\n        this.set_last_gold.x = 497 - this.set_last_gold.text.length * 13;\r\n        this.set_all_gold.text = this._ctrl.goldNum + \"\";\r\n        this.set_all_gold.x = 497 - this.set_all_gold.text.length * 13;\r\n        this.settlementBoard.visible = true;\r\n    }\r\n    closeSettlement() {\r\n        this.settlementBoard.visible = false;\r\n    }\r\n    leaveGameScene() {\r\n        this.close();\r\n        E.ins.event(EventName.openHome, 1);\r\n    }\r\n    showUnite() {\r\n        this.uniteAlert.visible = true;\r\n    }\r\n}\r\n",
  "references": [
    "C:/game/myLaya/src/controller/WarCtrl.ts",
    "C:/game/myLaya/src/manager/E.ts",
    "C:/game/myLaya/src/model/TerritoryData.ts",
    "C:/game/myLaya/src/ui/layaMaxUI.ts"
  ]
}
