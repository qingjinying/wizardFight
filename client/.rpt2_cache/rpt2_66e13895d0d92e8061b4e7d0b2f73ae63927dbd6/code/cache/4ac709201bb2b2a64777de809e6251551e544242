{
  "code": "import { E, EventName } from \"../manager/E\";\r\nimport { WarData } from \"../model/WarData\";\r\nimport { WarMapView } from \"../view/WarMapView\";\r\nexport class WarCtrl {\r\n    constructor() {\r\n        this.activieFlo = false;\r\n        this._data = new WarData();\r\n        this._view = new WarMapView(this);\r\n        E.ins.on(EventName.continueGame, this, this.continueGame);\r\n        E.ins.on(EventName.startGame, this, this.startGame);\r\n    }\r\n    continueGame() {\r\n        this.showView();\r\n    }\r\n    startGame() {\r\n        this._data = new WarData();\r\n        this._view.init();\r\n        this.showView();\r\n    }\r\n    showView() {\r\n        this._view.open();\r\n    }\r\n    get terMap() {\r\n        return this._data.terMap;\r\n    }\r\n    get goldNum() {\r\n        return this._data.gold;\r\n    }\r\n    get roundCount() {\r\n        return this._data.round;\r\n    }\r\n    get myId() {\r\n        return this._data.myId;\r\n    }\r\n    areaClick(areaID) {\r\n        this._data.currentId = areaID;\r\n        let flo = this._data.isMyTer(areaID);\r\n        if (flo) {\r\n            this._view.showOperationBox();\r\n        }\r\n        else {\r\n            let msg = this._data.getOtherMsg(areaID);\r\n            this._view.showOtherTer(msg);\r\n        }\r\n    }\r\n    recruitSoldier(num) {\r\n        this.activieFlo = true;\r\n        this._data.gold -= num;\r\n        let terData = this._data.getCurrentTer();\r\n        terData.soldierNum += num;\r\n        this._view.updateGold();\r\n        this._view.updateSoldier(terData);\r\n    }\r\n    getCurrentNeiborIdList() {\r\n        let terData = this._data.getCurrentTer();\r\n        return terData.neiborIdList;\r\n    }\r\n    getCurrentId() {\r\n        return this._data.currentId;\r\n    }\r\n    getCenter(areaID) {\r\n        let terData = this._data.getTerById(areaID);\r\n        return terData.centerPoint;\r\n    }\r\n    getCurrentSoldier() {\r\n        let terData = this._data.getCurrentTer();\r\n        return terData.soldierNum;\r\n    }\r\n    isMoveAvaliable(areaID) {\r\n        let neiborIdList = this.getCurrentNeiborIdList();\r\n        for (let id of neiborIdList) {\r\n            if (areaID == id) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n    moveSoldier(targetId, num) {\r\n        this.activieFlo = true;\r\n        let curArea = this._data.getCurrentTer();\r\n        curArea.soldierNum -= num;\r\n        let targetArea = this._data.getTerById(targetId);\r\n        if (targetArea.ownerId == this._data.myId) {\r\n            targetArea.soldierNum += num;\r\n        }\r\n        else {\r\n            this.fightCaculate(num, targetArea);\r\n        }\r\n        this._view.updateSoldier(curArea);\r\n        this._view.updateSoldier(targetArea);\r\n        this._view.updateAreaColor(targetArea);\r\n        if (targetArea.ownerId == this._data.myId) {\r\n            for (let id of targetArea.neiborIdList) {\r\n                let terData = this._data.getTerById(id);\r\n                this._view.updateSoldier(terData);\r\n            }\r\n            this.checkUnite();\r\n        }\r\n    }\r\n    checkUnite() {\r\n        for (let id in this._data.terMap) {\r\n            let terData = this._data.terMap[id];\r\n            if (terData.ownerId !== this._data.myId)\r\n                return;\r\n        }\r\n        this._view.showUnite();\r\n    }\r\n    fightCaculate(mySoldier, targetArea) {\r\n        let enemySoldier = targetArea.soldierNum;\r\n        let ratio = Math.random();\r\n        if (ratio < 0.5) {\r\n            ratio = ratio * 3;\r\n        }\r\n        let myReduce = ~~(targetArea.soldierNum * ratio);\r\n        let enemyReduce = 0;\r\n        let isWin;\r\n        if (mySoldier > myReduce) {\r\n            let remainNum = mySoldier - myReduce;\r\n            enemyReduce = enemySoldier;\r\n            isWin = true;\r\n            targetArea.changeOwner(this._data.myId, remainNum);\r\n        }\r\n        else {\r\n            enemyReduce = ~~(mySoldier / ratio);\r\n            myReduce = mySoldier;\r\n            isWin = false;\r\n            targetArea.soldierNum -= enemyReduce;\r\n            if (targetArea.ownerId != 1) {\r\n                targetArea.beAtttacked = true;\r\n            }\r\n        }\r\n        this._view.alertFightResult(mySoldier, enemySoldier, myReduce, enemyReduce, isWin);\r\n    }\r\n    roundEnd() {\r\n        let originalGold = this._data.gold;\r\n        let gold_add = 0;\r\n        let gold_consume = 0;\r\n        for (let id in this._data.terMap) {\r\n            let terData = this._data.terMap[id];\r\n            if (terData.ownerId == 1)\r\n                continue;\r\n            if (terData.ownerId == this._data.myId) {\r\n                gold_add += terData.goldProduct;\r\n                gold_consume += terData.soldierNum / 10;\r\n            }\r\n            else {\r\n                this.machine(terData);\r\n            }\r\n        }\r\n        gold_consume = ~~gold_consume;\r\n        this._data.gold += gold_add;\r\n        this._data.gold -= gold_consume;\r\n        this._view.alertSettlement(originalGold, gold_add, gold_consume);\r\n        this._data.round++;\r\n        this.activieFlo = false;\r\n        this._view.refreshInfoBoard();\r\n    }\r\n    machine(terData) {\r\n        terData.soldierNum += terData.soldierProduct;\r\n        if ((terData.ownerId % 2) !== (this._data.round % 2))\r\n            return;\r\n        if (Math.random() < 0.4)\r\n            return;\r\n        for (let neiberId of terData.neiborIdList) {\r\n            let neiberData = this._data.getTerById(neiberId);\r\n            if (neiberData.ownerId == 1) {\r\n                neiberData.changeOwner(terData.ownerId, 1000);\r\n                this._view.updateAreaColor(neiberData);\r\n                this._view.updateSoldier(neiberData);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n}\r\n",
  "references": [
    "C:/game/demo1/myLaya/src/manager/E.ts",
    "C:/game/demo1/myLaya/src/model/TerritoryData.ts",
    "C:/game/demo1/myLaya/src/model/WarData.ts",
    "C:/game/demo1/myLaya/src/view/WarMapView.ts"
  ]
}
